name: CI/CD Deploy to Linux

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ================================
      # ğŸ”„ Checkout source code
      # ================================
      - name: ğŸ”„ Checkout code tá»« nhÃ¡nh main
        uses: actions/checkout@v3

      # ================================
      # ğŸš€ Deploy lÃªn server qua SSH
      # ================================
      - name: ğŸš€ Deploy Docker trÃªn server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 8686
          script: |
            echo "===== ğŸ›  Start Deploy GreenMap-Frontend ====="
            cd /home/GreenMap-Frontend

            echo "ğŸ“¥ Pull code má»›i nháº¥t tá»« GitHub"
            git reset --hard
            git checkout main
            git pull origin main

            echo "ğŸ³ Dá»«ng Docker cÅ©"
            docker compose down || true

            echo "ğŸ³ Build Docker image má»›i"
            docker compose build --no-cache

            echo "ğŸš€ Khá»Ÿi Ä‘á»™ng láº¡i dá»‹ch vá»¥"
            docker compose up -d

            echo "===== âœ… Deploy thÃ nh cÃ´ng ====="

      # ================================
      # ğŸ“£ THÃ”NG BÃO THÃ€NH CÃ”NG
      # ================================
      - name: ğŸ“£ ThÃ´ng bÃ¡o deploy thÃ nh cÃ´ng (Discord)
        if: success()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          PIPELINE_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
          -d "{
            \"content\": \"@everyone ğŸš€ **Deploy thÃ nh cÃ´ng!**\",
            \"embeds\": [{
              \"title\": \"GreenMap-Frontend Ä‘Ã£ deploy thÃ nh cÃ´ng\",
              \"description\": \"Dá»± Ã¡n Ä‘Ã£ cháº¡y phiÃªn báº£n má»›i nháº¥t tá»« nhÃ¡nh **main**.\",
              \"color\": 5763719,
              \"fields\": [
                {\"name\": \"ğŸ“ Commit\", \"value\": \"${COMMIT_MSG}\"},
                {\"name\": \"ğŸ‘¤ TÃ¡c giáº£\", \"value\": \"${AUTHOR}\"},
                {\"name\": \"ğŸ”— Pipeline\", \"value\": \"[Xem pipeline táº¡i Ä‘Ã¢y](${PIPELINE_URL})\"},
                {\"name\": \"ğŸ•’ Thá»i gian\", \"value\": \"$(date)\"}
              ]
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK }}

      # ================================
      # âŒ THÃ”NG BÃO THáº¤T Báº I
      # ================================
      - name: âŒ ThÃ´ng bÃ¡o deploy tháº¥t báº¡i (Discord)
        if: failure()
        run: |
          PIPELINE_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
          -d "{
            \"content\": \"@everyone âŒ **Deploy tháº¥t báº¡i!**\",
            \"embeds\": [{
              \"title\": \"Lá»—i trong quÃ¡ trÃ¬nh deploy GreenMap-Frontend\",
              \"description\": \"Vui lÃ²ng kiá»ƒm tra láº¡i logs cá»§a GitHub Actions.\",
              \"color\": 15548997,
              \"fields\": [
                {\"name\": \"ğŸ”— Pipeline\", \"value\": \"[Xem lá»—i táº¡i Ä‘Ã¢y](${PIPELINE_URL})\"},
                {\"name\": \"ğŸ•’ Thá»i gian\", \"value\": \"$(date)\"}
              ]
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK }}
